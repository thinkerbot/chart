#!/usr/bin/env ruby

begin
  require 'optparse'
  require 'chart'
  require 'irb'
  require 'shellwords'
  require 'csv'

  options = Chart.options(
    :mode => :console,
  )
  OptionParser.new do |opts|
    opts.banner = %{
usage: chart-console [options]

  Gives you a console with the cql connection set up as normal.

    $ chart-console
    > conn.exec("select * from charts")
    ...

options:

}.lstrip

    opts.on("-c", "--config-file CONFIG_FILE", "database config file (#{options[:database_file]})") do |value|
      options[:database_file] = value
    end

    opts.on("-H", "--hosts HOST[,HOST]", "override hosts config") do |value|
      options[:config][:hosts] = value.split(',')
    end

    opts.on("-e", "--environment ENV", "environment (#{options[:environment]})") do |value|
      options[:environment] = value
    end

    opts.on("-o", "--option KEY=VALUE", "override config option") do |option|
      key, value = option.split('=', 2)
      options[:config][key.to_sym] = value == '-' ? nil : value
    end

    opts.on("-h", "--help", "print this help") do
      puts opts
      puts
      puts Chart.version
      exit
    end

    opts.on("-P", "--port PORT", "override port config") do |value|
      options[:config][:port] = value
    end

    opts.on("-p", "--print-cmd", "print database shell command") do
      options[:mode] = :print_shell_command
    end

    opts.on("--print-config", "print client config") do
      options[:mode] = :print_config
    end

    opts.on("-q", "--shell", "launch database shell with argv") do
      options[:mode] = :launch_shell
    end

    opts.on("-x", "--execute QUERY", "execute query") do |value|
      options[:mode] = value
    end

    opts.on("--version", "print version information") do |node|
      puts Chart.version
      exit
    end
  end.parse!
  Chart.setup(options)

  def conn
    Chart.conn
  end

  def config
    conn.config
  end

  mode = options[:mode]
  case mode
  when :console
    ARGV.clear
    IRB.start(__FILE__)

  when :print_config
    print_config = {}
    config.keys.map(&:to_s).sort.each do |key|
      print_config[key] = config[key.to_sym]
    end
    puts print_config.to_yaml

  when :launch_shell, :print_shell_command
    command, env = conn.connection_command
    command = Shellwords.shelljoin(command + ARGV)

    if mode == :print_shell_command
      puts command
    else
      env.each_pair {|key, value| ENV[key] = value }
      exec command
    end

  else
    Chart.setup(options)
    rows = conn.execute(mode)
    CSV($stdout) do |csv|
      rows.each do |row|
        csv << row.values
      end
    end
  end
rescue
  raise if $DEBUG
  $stderr.puts $!.message
  exit 1
end
